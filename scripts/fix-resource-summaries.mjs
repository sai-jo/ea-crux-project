#!/usr/bin/env node

/**
 * Fix resources with JSON blobs in summary field
 * Uses regex to extract fields since JSON may have control chars
 */

import { readFileSync, writeFileSync } from 'fs';
import yaml from 'yaml';

const RESOURCES_PATH = 'src/data/resources.yaml';

const content = readFileSync(RESOURCES_PATH, 'utf-8');
const resources = yaml.parse(content);

let fixed = 0;

for (const resource of resources) {
  if (resource.summary && resource.summary.trim().startsWith('{')) {
    const text = resource.summary;

    // Extract oneLiner using regex - handle escaped quotes and newlines
    const oneLinerMatch = text.match(/"oneLiner":\s*"((?:[^"\\]|\\.)*)"/);
    // Extract summary (the nested one) using regex
    const summaryMatch = text.match(/"summary":\s*"((?:[^"\\]|\\.)*)"/);
    // Extract review using regex
    const reviewMatch = text.match(/"review":\s*"((?:[^"\\]|\\.)*)"/);
    // Extract keyPoints as array
    const keyPointsMatch = text.match(/"keyPoints":\s*\[\s*((?:[^\]\\]|\\.)*)\s*\]/s);

    const newSummary = oneLinerMatch?.[1] || summaryMatch?.[1];

    if (newSummary) {
      // Unescape the string
      resource.summary = newSummary
        .replace(/\\n/g, ' ')
        .replace(/\\"/g, '"')
        .replace(/\\\\/g, '\\')
        .trim();
      fixed++;
    }

    // Try to extract review if we don't have one
    if (reviewMatch?.[1] && !resource.review) {
      resource.review = reviewMatch[1]
        .replace(/\\n\\n/g, '\n\n')
        .replace(/\\n/g, ' ')
        .replace(/\\"/g, '"')
        .replace(/\\\\/g, '\\')
        .trim();
    }

    // Try to extract key_points if we don't have them
    if (keyPointsMatch?.[1] && !resource.key_points) {
      const pointsStr = keyPointsMatch[1];
      const points = [];
      const pointMatches = pointsStr.matchAll(/"((?:[^"\\]|\\.)*)"/g);
      for (const m of pointMatches) {
        points.push(m[1].replace(/\\"/g, '"').replace(/\\n/g, ' '));
      }
      if (points.length > 0) {
        resource.key_points = points;
      }
    }
  }
}

// Write back with proper YAML formatting
const output = yaml.stringify(resources, {
  lineWidth: 100,
});

writeFileSync(RESOURCES_PATH, '# External Resources Referenced in the Knowledge Base\n' +
  '# ==================================================\n' +
  '#\n' +
  '# Auto-generated by: node scripts/export-resources.mjs\n' +
  '# Last exported: ' + new Date().toISOString() + '\n' +
  '#\n' +
  '# Manual edits are preserved on re-export.\n' +
  '# See src/data/schema.ts for Resource schema.\n\n' +
  output);

console.log(`Fixed ${fixed} resources`);

---
/**
 * Individual Resource Page
 *
 * Displays detailed information about a single external resource,
 * including abstract, summary, review, and citing articles.
 */
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { resources, getEntityWithPath } from '../../../data';
import type { Resource } from '../../../data/schema';

export function getStaticPaths() {
  return resources.map((resource) => ({
    params: { id: resource.id },
    props: { resource },
  }));
}

interface Props {
  resource: Resource;
}

const { resource } = Astro.props;

// Get citing articles with their titles and paths
const citingArticles = (resource.cited_by || [])
  .map((id) => getEntityWithPath(id))
  .filter(Boolean);

const typeIcons: Record<string, string> = {
  paper: 'ğŸ“„',
  book: 'ğŸ“š',
  blog: 'âœï¸',
  report: 'ğŸ“‹',
  talk: 'ğŸ¤',
  podcast: 'ğŸ§',
  government: 'ğŸ›ï¸',
  reference: 'ğŸ“–',
  web: 'ğŸ”—',
};

const icon = typeIcons[resource.type] || 'ğŸ”—';
const typeLabel = resource.type.charAt(0).toUpperCase() + resource.type.slice(1);

// Format authors
const authorText = resource.authors?.join(', ') || 'Unknown author';
---

<StarlightPage
  frontmatter={{
    title: resource.title,
    description: resource.summary || `External ${typeLabel} resource`,
    tableOfContents: false,
  }}
  headings={[]}
>
  <div class="resource-detail">
    <div class="resource-meta">
      <span class="type-badge">{icon} {typeLabel}</span>
      {resource.importance && (
        <span class="importance-badge">Importance: {resource.importance}</span>
      )}
    </div>

    <p class="author-line">
      {authorText}
      {resource.published_date && <span> Â· {resource.published_date}</span>}
    </p>

    <p>
      <a href={resource.url} target="_blank" rel="noopener noreferrer" class="external-link">
        View Original â†—
      </a>
    </p>

    {resource.summary && (
      <section>
        <h2>Summary</h2>
        <p>{resource.summary}</p>
      </section>
    )}

    {resource.abstract && (
      <section>
        <h2>Abstract</h2>
        <p>{resource.abstract}</p>
      </section>
    )}

    {resource.review && (
      <section>
        <h2>Review</h2>
        <p set:html={resource.review.replace(/\n\n/g, '</p><p>').replace(/\n/g, ' ')} />
      </section>
    )}

    {resource.key_points && resource.key_points.length > 0 && (
      <section>
        <h2>Key Points</h2>
        <ul>
          {resource.key_points.map((point) => (
            <li>{point}</li>
          ))}
        </ul>
      </section>
    )}

    <section>
      <h2>Cited By ({citingArticles.length} articles)</h2>
      {citingArticles.length > 0 ? (
        <ul>
          {citingArticles.map((article) => (
            <li>
              <a href={article.href}>{article.title}</a>
            </li>
          ))}
        </ul>
      ) : (
        <p class="empty-state">Not currently cited by any articles in the knowledge base.</p>
      )}
    </section>

    <p style="margin-top: 2rem;">
      <a href="/browse/resources/">â† Back to Resources</a>
    </p>
  </div>
</StarlightPage>

<style>
  .resource-detail {
    max-width: 100%;
  }

  .resource-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .type-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    background: var(--sl-color-accent-low);
    color: var(--sl-color-accent-high);
  }

  .importance-badge {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--sl-color-gray-5);
    color: var(--sl-color-gray-1);
  }

  .author-line {
    color: var(--sl-color-gray-3);
    font-size: 0.95rem;
    margin-bottom: 1rem;
  }

  .external-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--sl-color-text-accent);
    font-weight: 500;
  }

  section {
    margin-top: 2rem;
  }

  section h2 {
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
  }

  .empty-state {
    color: var(--sl-color-gray-3);
    font-style: italic;
  }
</style>
